{% extends "layout.html" %}

{% block title %}Preview Anime List{% endblock %}

{% block main %}
<h2 class="mb-4 text-center">My Anime List</h2>

{% if anime_list %}
<div class="form-check form-switch mb-4 d-flex justify-content-center">
    <input class="form-check-input" type="checkbox" role="switch" id="sortToggle"
           onchange="location.href=this.checked ? '?sort_by_rating=1' : window.location.pathname;"
           {% if sort_active %}checked{% endif %}>
    <label class="form-check-label ms-2" for="sortToggle">
        Sort by rating (high to low)
    </label>
</div>

<div class="d-flex justify-content-center mb-4 gap-3 flex-wrap">
    <a href="{{ url_for('export') }}" class="btn btn-outline-primary">üì§ Export CSV</a>
    <input type="text" id="searchBox" class="form-control" placeholder="Search anime..." style="max-width: 300px;">
    <button class="btn btn-outline-secondary" id="toggleEdit">üîß Show Edit/Delete</button>
    <button class="btn btn-outline-secondary" id="toggleDetail">‚ú® Show View/Add</button>
</div>

<div class="container-fluid px-0" id="animeList">
    {% for anime in anime_list %}
    <div class="mb-4 anime-card" id="anime-{{ anime.id }}">
        <div class="card text-white shadow-lg position-relative overflow-hidden border-0 mx-auto"
             style="
                 border-radius: 1.5rem;
                 min-height: 400px;
                 background-size: cover;
                 background-position: center;
                 background-image: url('{{ (anime.background_url if anime.background_url.startswith('http') else url_for('static', filename=anime.background_url)) if anime.background_url else url_for('static', filename='default.jpg') }}');
                 max-width: 1200px;
                 width: 100%;
             ">
            <!-- Date Badge -->
            {% if anime.date %}
            <div class="position-absolute top-0 start-0 p-2" style="z-index:2;">
                <span class="badge bg-dark" title="{{ anime.date }}">{{ anime.date|datetimeformat('%b %Y') }}</span>
            </div>
            {% endif %}

            <!-- Edit & Delete Controls -->
            <div class="position-absolute top-0 end-0 p-2 d-flex gap-1 edit-controls" style="z-index:2;">
                <form method="post" action="{{ url_for('delete', anime_id=anime.id) }}" onsubmit="return confirm('Delete this anime?');">
                    <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                </form>
                <a href="{{ url_for('edit', anime_id=anime.id) }}" class="btn btn-sm btn-light"><i class="bi bi-pencil"></i></a>
            </div>

            <!-- Content -->
            <div class="card-body bg-dark bg-opacity-75 text-white rounded-4 m-3 position-relative" style="min-height: 220px;">
                <div class="row g-0 align-items-center">
                    <div class="col-md-8">
                        <h4 class="card-title">{{ anime.title }}</h4>
                        <p class="card-text mb-1">‚≠ê <strong>{{ anime.rating }}/10</strong></p>
                        {% if anime.thoughts %}
                            <p class="card-text"><strong>Thoughts:</strong> {{ anime.thoughts }}</p>
                        {% endif %}
                        {% if anime.sequel %}
                            <p class="card-text"><strong>Sequel of:</strong> {{ anime.sequel }}</p>
                        {% endif %}
                        {% if anime.details_url and anime.details_url is string and anime.details_url|length > 0 and anime.details_url.startswith('http') %}
                            <p class="card-text"><a class="text-info" href="{{ anime.details_url }}" target="_blank">More Details</a></p>
                        {% endif %}
                    </div>
                    {% if anime.poster_url %}
                    <div class="col-md-4 d-flex justify-content-end align-items-center">
                        <img src="{{ anime.poster_url if anime.poster_url.startswith('http') else url_for('static', filename=anime.poster_url) }}" class="img-fluid rounded shadow" alt="Anime Poster" style="max-width: 220px; max-height: 320px;">
                    </div>
                    {% endif %}
                </div>
                <div class="position-absolute bottom-0 end-0 m-2 d-flex gap-2 detail-controls">
                    {% if anime.id in detail_ids %}
                        <a href="{{ url_for('detail', anime_id=anime.id) }}" class="btn btn-sm btn-light" title="View Details">üîç</a>
                    {% endif %}
                    <a href="{{ url_for('edit_detail', anime_id=anime.id) }}" class="btn btn-sm btn-success" title="Add/Edit Details">‚ûï</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="text-muted text-center">No anime entries yet. <a href="/add">Add your first anime</a>!</p>
{% endif %}
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .edit-controls {
        display: none !important;
    }
    .edit-controls.show {
        display: flex !important;
    }
    .detail-controls {
        display: none !important;
    }
    .detail-controls.show {
        display: flex !important;
    }
</style>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchBox = document.getElementById("searchBox");
        const cards = document.querySelectorAll(".anime-card");
        const toggleBtn = document.getElementById("toggleEdit");
        const editControls = document.querySelectorAll(".edit-controls");
        const detailToggleBtn = document.getElementById("toggleDetail");
        const detailControls = document.querySelectorAll(".detail-controls");

        let showEditControls = false;
        let showDetailControls = false;

        // Search
        if (searchBox) {
            searchBox.addEventListener("input", () => {
                const term = searchBox.value.toLowerCase();
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(term) ? "block" : "none";
                });
            });
        }

        // Edit toggle
        if (toggleBtn) {
            toggleBtn.addEventListener("click", () => {
                showEditControls = !showEditControls;
                editControls.forEach(el => el.classList.toggle("show", showEditControls));
                toggleBtn.textContent = showEditControls ? "‚ùå Hide Edit/Delete" : "üîß Show Edit/Delete";
            });
        }

        // Detail toggle
        if (detailToggleBtn) {
            detailToggleBtn.addEventListener("click", () => {
                showDetailControls = !showDetailControls;
                detailControls.forEach(el => el.classList.toggle("show", showDetailControls));
                detailToggleBtn.textContent = showDetailControls ? "‚ùå Hide View/Add" : "‚ú® Show View/Add";
            });
        }

        // Scroll to hash
        const hash = window.location.hash;
        if (hash) {
            const target = document.querySelector(hash);
            if (target) {
                setTimeout(() => {
                    target.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 200);
            }
        }
    });
</script>
{% endblock %}
